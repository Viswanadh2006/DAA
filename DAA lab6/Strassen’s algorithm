#include <stdio.h>
#include <stdlib.h>

int **create(int n) {
    int **m = malloc(n * sizeof(int *));
    for (int i = 0; i < n; i++) m[i] = calloc(n, sizeof(int));
    return m;
}

void freeM(int **m, int n) {
    for (int i = 0; i < n; i++) free(m[i]);
    free(m);
}

int **add(int **A, int **B, int n) {
    int **C = create(n);
    for (int i=0;i<n;i++) for (int j=0;j<n;j++) C[i][j]=A[i][j]+B[i][j];
    return C;
}

int **sub(int **A, int **B, int n) {
    int **C = create(n);
    for (int i=0;i<n;i++) for (int j=0;j<n;j++) C[i][j]=A[i][j]-B[i][j];
    return C;
}

int **strassen(int **A, int **B, int n) {
    if (n==1) {
        int **C=create(1);
        C[0][0]=A[0][0]*B[0][0];
        return C;
    }
    int k=n/2;
    int **A11=create(k),**A12=create(k),**A21=create(k),**A22=create(k);
    int **B11=create(k),**B12=create(k),**B21=create(k),**B22=create(k);

    for(int i=0;i<k;i++) for(int j=0;j<k;j++) {
        A11[i][j]=A[i][j];      A12[i][j]=A[i][j+k];
        A21[i][j]=A[i+k][j];    A22[i][j]=A[i+k][j+k];
        B11[i][j]=B[i][j];      B12[i][j]=B[i][j+k];
        B21[i][j]=B[i+k][j];    B22[i][j]=B[i+k][j+k];
    }

    int **M1=strassen(add(A11,A22,k), add(B11,B22,k), k);
    int **M2=strassen(add(A21,A22,k), B11, k);
    int **M3=strassen(A11, sub(B12,B22,k), k);
    int **M4=strassen(A22, sub(B21,B11,k), k);
    int **M5=strassen(add(A11,A12,k), B22, k);
    int **M6=strassen(sub(A21,A11,k), add(B11,B12,k), k);
    int **M7=strassen(sub(A12,A22,k), add(B21,B22,k), k);

    int **C=create(n);
    for(int i=0;i<k;i++) for(int j=0;j<k;j++) {
        C[i][j]       = M1[i][j]+M4[i][j]-M5[i][j]+M7[i][j];
        C[i][j+k]     = M3[i][j]+M5[i][j];
        C[i+k][j]     = M2[i][j]+M4[i][j];
        C[i+k][j+k]   = M1[i][j]-M2[i][j]+M3[i][j]+M6[i][j];
    }
    return C;
}

int main() {
    int n; 
    printf("Enter size (power of 2): ");
    scanf("%d",&n);

    int **A=create(n), **B=create(n);
    printf("Enter A:\n");
    for(int i=0;i<n;i++) for(int j=0;j<n;j++) scanf("%d",&A[i][j]);
    printf("Enter B:\n");
    for(int i=0;i<n;i++) for(int j=0;j<n;j++) scanf("%d",&B[i][j]);

    int **C=strassen(A,B,n);
    printf("Result:\n");
    for(int i=0;i<n;i++){ 
        for(int j=0;j<n;j++) printf("%d ",C[i][j]); 
        printf("\n"); 
    }
}
